%% demo_dng_rendering.m
% Author: Jesse Chen
% This is a demo showing how dng rendering pipeline works.

%% read tif image
img = imread('demo_0022_III.tif');
%img = double(img(1:1000, 1:1000, :))/65535.0;
img = double(img)/65535.0;

%% colorMatrix
colorMatrix1 = [
      1.3488  -0.8849   0.0929
     -0.1484   0.7881   0.4303
     -0.0302   0.0979   0.5113    
];

colorMatrix2 = [
      0.8760  -0.2517  -0.0607
     -0.2745   1.0465   0.2644
     -0.0943   0.1792   0.5458 
];

%% AsShotNeutral
camera_neutral = [0.5570; 1.0000; 0.5161];

%%
camera_neutral_xy = NeutralToXY(camera_neutral, colorMatrix1, colorMatrix2);
dng_white = SetWhiteXY(camera_neutral_xy, colorMatrix1, colorMatrix2);

%%
fCameraWhite = camera_neutral;
proPhoto = dng_space_ProPhoto();

fCameraToRGB = proPhoto.fMatrixFromPCS * dng_white.fCameraToPCS;

%%
% white balance has been applied
rgb = RefBaselineABCtoRGB(img, fCameraWhite, fCameraToRGB);

%%
hsv_map1 = [  
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
  0.0000 1.0000 1.0000
-13.8613 1.0682 1.0250
 -1.1697 0.9973 0.9787
 -0.4599 1.0115 0.9573
 -1.4927 1.0287 0.9572
 -1.6609 1.0094 1.0099
 -4.6886 0.8788 1.0000
 -4.6886 0.8788 1.0293
  1.8960 1.0465 1.0038
  2.5498 1.0632 0.9963
 -0.5287 1.0069 1.0096
 -1.8994 0.9953 1.0373
  3.1268 1.0009 1.0000
  3.1268 1.0009 1.0120
 -3.7958 1.1574 0.9906
 -2.6821 1.0792 1.0037
 -1.2565 1.0172 1.0245
 -0.2708 0.9975 1.0211
  9.5966 1.0968 1.0000
  9.5966 1.0968 1.0664
 -4.7047 1.0365 1.0287
 -4.8448 1.0111 1.0380
 -2.8434 0.9909 1.0506
 -0.3547 0.9926 1.0364
  3.1749 1.2825 1.0000
  3.1749 1.2825 1.1234
 -0.2597 1.0778 1.1274
 -0.2369 1.0176 1.1320
  0.9175 0.9925 1.1160
  3.0627 0.9853 1.0556
-16.7785 1.3534 1.0000
-16.7785 1.3534 1.1375
-13.2752 1.1289 1.1552
 -8.4315 1.0466 1.1439
 -3.5381 1.0138 1.1129
 -1.1897 1.0027 1.0804
  0.0000 1.0000 1.0000
-11.5030 1.0630 1.0314
 -0.2006 0.9909 0.9977
 -1.5225 1.0138 0.9939
 -1.5134 1.0162 1.0020
 -1.2055 1.0018 1.0106
 -4.6695 0.9128 1.0000
 -4.6695 0.9128 1.0350
  1.9859 1.0595 1.0208
  0.5512 1.0157 1.0259
 -1.2893 0.9877 1.0455
 -1.3406 0.9952 1.0343
  1.3395 0.9999 1.0000
  1.3395 0.9999 1.0153
 -3.4281 1.1248 1.0093
 -1.7161 1.0393 1.0293
 -0.2303 0.9942 1.0259
 -0.0369 0.9973 1.0083
  7.3479 1.0786 1.0000
  7.3479 1.0786 1.0547
 -4.8716 1.0407 1.0305
 -3.3024 1.0083 1.0394
 -0.4885 0.9934 1.0327
  0.0436 0.9958 1.0246
  2.6680 1.2410 1.0000
  2.6680 1.2410 1.1028
 -1.0547 1.0685 1.0978
 -0.1072 1.0071 1.0891
  0.5733 0.9943 1.0749
  3.0627 0.9853 1.0294
-14.7890 1.2993 1.0000
-14.7890 1.2993 1.1155
-10.8892 1.0939 1.1186
 -5.5982 1.0296 1.0919
 -2.4639 1.0082 1.0663
 -0.6571 1.0015 1.0364
 ];

hsv_map2 = [
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
    0.0000 1.0000 1.0000
   -5.2344 0.9680 1.0260
   -1.5137 0.9622 0.9826
   -2.6487 1.0159 0.9510
   -2.6785 1.0398 0.9339
   -1.3234 1.0222 0.9985
   -0.8006 0.9391 1.0000
   -0.8006 0.9391 1.0425
    0.9376 0.9869 1.0252
    0.3221 0.9900 1.0028
   -3.0700 0.9860 0.9996
   -4.8422 0.9928 1.0256
    2.3401 1.0193 1.0000
    2.3401 1.0193 1.0319
    0.8825 1.0244 1.0048
    0.7883 0.9918 0.9684
    0.8000 0.9807 0.9611
   -0.3895 0.9884 1.0189
    0.0981 1.0280 1.0000
    0.0981 1.0280 1.0531
   -3.4501 1.0425 1.0520
   -0.4291 1.0066 1.0270
    2.3361 1.0008 1.0317
    3.6932 0.9922 1.0590
    0.6163 1.0580 1.0000
    0.6163 1.0580 1.0760
   -0.2669 1.0113 1.0807
    0.2119 0.9958 1.0840
    1.1458 0.9983 1.0594
    1.1759 1.0027 1.0003
   -7.6616 1.0938 1.0000
   -7.6616 1.0938 1.0837
   -5.8386 1.0381 1.0903
   -3.1300 1.0257 1.0713
   -1.2942 1.0199 1.0513
    0.8422 1.0094 1.0519
    0.0000 1.0000 1.0000
   -4.0815 0.9495 1.0489
   -2.5402 0.9666 1.0150
   -4.1932 1.0237 0.9881
   -3.1777 1.0327 0.9883
   -0.9004 1.0135 1.0383
   -0.1787 0.9426 1.0000
   -0.1787 0.9426 1.0628
    1.3158 0.9826 1.0520
   -1.5996 0.9627 1.0381
   -4.2096 0.9657 1.0366
   -4.5291 0.9927 1.0381
    1.6368 1.0229 1.0000
    1.6368 1.0229 1.0513
    2.0535 0.9967 1.0197
    2.7156 0.9741 0.9857
    0.9505 0.9735 0.9852
   -0.2031 0.9884 1.0036
   -0.8685 1.0275 1.0000
   -0.8685 1.0275 1.0671
   -1.5729 1.0254 1.0563
    2.6302 1.0128 1.0532
    5.5382 1.0083 1.0781
    4.4328 0.9943 1.0785
   -0.6663 1.0383 1.0000
   -0.6663 1.0383 1.0833
   -1.2542 1.0138 1.0829
    0.0047 0.9961 1.0753
    0.8352 1.0002 1.0558
    0.9976 1.0017 1.0121
   -7.6224 1.0526 1.0000
   -7.6224 1.0526 1.0921
   -5.6787 1.0287 1.0901
   -3.7875 1.0274 1.0770
   -1.8273 1.0199 1.0613
    0.1765 1.0065 1.0505    
];

HueSatDeltas1.fHueDivisions = 6;
HueSatDeltas1.fSatDivisions = 6;
HueSatDeltas1.fValDivisions = 3;
HueSatDeltas1.Deltas = hsv_map1;

HueSatDeltas2.fHueDivisions = 6;
HueSatDeltas2.fSatDivisions = 6;
HueSatDeltas2.fValDivisions = 3;
HueSatDeltas2.Deltas = hsv_map2;

%%
hsv_map = HueSatMapForWhite(camera_neutral_xy, HueSatDeltas1, HueSatDeltas2, 2850, 6500);
mapped_rgb = RefBaselineHueSatMap(rgb, hsv_map);

%%
tone_mapped_rgb = dng_rendering_acr3_tone_mapping(mapped_rgb);
clear mapped_rgb;

%%
sRGB = dng_space_sRGB();
fRGBtoFinal = sRGB.fMatrixFromPCS * proPhoto.fMatrixToPCS;
sRGB_img = RefBaselineRGBtoRGB(tone_mapped_rgb, fRGBtoFinal);

%%
sRGB_img = dng_gamma_2_2_mapping(sRGB_img);

figure; imshow(sRGB_img, [0 1]);

imwrite(sRGB_img, 'demo_0022_srgb.jpg', 'Quality', 98);